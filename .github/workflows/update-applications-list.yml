name: Update Applications List

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed
    branches:
      - main
      - master

jobs:
  update-list:
    name: Update Applications List
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate applications list
        shell: pwsh
        run: |
          .\bin\generate-applications-list.ps1

      - name: Check for changes
        id: git-check
        shell: pwsh
        run: |
          git diff --exit-code APPLICATIONS.md
          if ($LASTEXITCODE -eq 1) {
            echo "changed=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "changed=false" >> $env:GITHUB_OUTPUT
          }

      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add APPLICATIONS.md
          git commit -m "Update APPLICATIONS.md automatically"
          git push

      - name: Check for incomplete manifests
        id: check-incomplete
        shell: pwsh
        run: |
          if (Test-Path 'incomplete-manifests.json') {
            $data = Get-Content 'incomplete-manifests.json' | ConvertFrom-Json
            echo "count=$($data.Count)" >> $env:GITHUB_OUTPUT
            echo "has_incomplete=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_incomplete=false" >> $env:GITHUB_OUTPUT
          }

      - name: Find existing issue
        if: steps.check-incomplete.outputs.has_incomplete == 'true'
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'manifest-incomplete',
              state: 'open'
            });

            if (issues.data.length > 0) {
              core.setOutput('issue_number', issues.data[0].number);
              core.setOutput('issue_exists', 'true');
            } else {
              core.setOutput('issue_exists', 'false');
            }

      - name: Create or update issue for incomplete manifests
        if: steps.check-incomplete.outputs.has_incomplete == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('incomplete-manifests.json', 'utf8'));

            let body = `## Incomplete Manifests Found\n\n`;
            body += `There are **${data.Count}** manifest(s) with missing fields:\n\n`;
            body += `| Package Name | Missing Fields |\n`;
            body += `|--------------|----------------|\n`;

            for (const app of data.Apps) {
              const fields = app.MissingFields.join(', ');
              body += `| \`${app.PackageName}\` | ${fields} |\n`;
            }

            body += `\n---\n*This issue is automatically managed. It will be closed when all manifests are complete.*`;

            const issueExists = core.getInput('issue_exists') === 'true';

            if (issueExists) {
              const issueNumber = parseInt(core.getInput('issue_number'));
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
              console.log(`Updated issue #${issueNumber}`);
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Incomplete Manifests Need Attention',
                body: body,
                labels: ['manifest-incomplete']
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Close issue if all manifests are complete
        if: steps.check-incomplete.outputs.has_incomplete == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'manifest-incomplete',
              state: 'open'
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'All manifests are now complete! ðŸŽ‰'
              });

              console.log(`Closed issue #${issue.number}`);
            }
